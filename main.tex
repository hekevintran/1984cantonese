% Author: Quincy Lam (林立崑)
% Licensed under Creative Commons BY-NC-SA 3.0
\documentclass[a5paper,12pt]{memoir}
%No need to use -papersize
\usepackage{fontspec}
\setmainfont{Sun-ExtA}
\usepackage[fallback]{xeCJK}
\usepackage{rotating}
\usepackage{adjustbox}
\usepackage{verbatim}
\usepackage[normalem]{ulem}
\usepackage{lscape}
\usepackage{etoolbox}
\usepackage[backend=biber,style=authoryear]{biblatex}
\addbibresource{main.bib}
\newfontlanguage{Chinese}{CHN}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FONTS

%\xeCJKDeclareSubCJKBlock{puncts}{`。,`，,`、,`？,`！,`：,`；,`﹃,`﹄,`﹁,`﹂}
\xeCJKDeclareSubCJKBlock{puncts}{"FE10 -> "FE19, "FE30 -> "FE48}
\setCJKfamilyfont{zhvert}[puncts={[Vertical=RotatedGlyphs]{AR PL UMing HK}}, Vertical=RotatedGlyphs]{Sun-ExtA} 
\setCJKfallbackfamilyfont{zhvert}[Vertical=RotatedGlyphs]{Sun-ExtB}
\setCJKmainfont[puncts=AR PL UMing HK]{Sun-ExtA}
\setCJKfallbackfamilyfont{rm}[]{Sun-ExtB}

\setCJKfamilyfont{em}[puncts={[Vertical=RotatedGlyphs]{AR PL UKai HK}}, Vertical=RotatedGlyphs]{AR PL UKai HK}

%sbw = Sun-ExtB wrap
\newcommand*{\sbw}[1]{\setmainfont{Sun-ExtB}#1\setmainfont{Sun-ExtA}}


%。，、？！：；「」『』
%︐︑︒︓︔︕︖﹃﹄﹁﹂︵︶︽︾︙︱

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PAGE LAYOUT



\makepagestyle{myPage}{%
}
\makeevenhead{myPage}{}{\leftmark}{\thepage}
\makeoddhead{myPage}{\thepage}{\rightmark}{}
\makeevenfoot{myPage}{}{}{}
\makeoddfoot{myPage}{}{}{}


\makepsmarks{myPage}{
\def\partmark##1{\markboth{##1}{}} 
\def\chaptermark##1{\markright{##1}} 
}

% Chapter pages use the plain style, so we will change it in order to place the page numbers where I want them
\makeoddhead{plain}{\thepage}{}{}
\makeoddfoot{plain}{}{}{}


\makechapterstyle{myChapter}{%
	\def\chapterheadstart{\vspace*{\beforechapskip}}
	\def\chapnamefont {\CJKfamily{zhvert} \large}
	%\def\printchaptername{\chapnamefont \@chapapp}
	\def\printchaptername{}
	%\def\chapternamenum{\space}
	\def\chapternamenum{}
	%\def\printchapternum{\chapnumfont \thechapter}
	\def\printchapternum{}
	%\def\afterchapternum{\par\nobreak\vskip \midchapskip}
	\def\printchaptertitle##1{\chapnamefont ##1}
	%\def\afterchaptertitle{\par\nobreak\vskip \afterchapskip}

}


%For the part 1,2,3 pages
\renewcommand*{\printpartname}{}
\renewcommand*{\partnamenum}{}
\renewcommand*{\printpartnum}{}
\renewcommand*{\parttitlefont}{\Huge\CJKfamily{zhvert}}


%One day figure out how this works
%http://tex.stackexchange.com/questions/38593/rotating-text-by-90-degrees
\begin{comment}
\let\antilandscape\landscape
\let\endantilandscape\endlandscape
\def\LS@antirot{%
\setbox\@outputbox\vbox{\hbox{\rotatebox{-180}{\box\@outputbox}}}
}
\patchcmd{\antilandscape}{\LS@rot}{\LS@antirot}{}{}
\end{comment}

\makeatletter
\renewcommand*{\LS@rot}{%
  \setbox\@outputbox\vbox{\hbox{\rotatebox{-90}{\box\@outputbox}}}}
\makeatother

% A square of sidelength (1-x) consumes half of the area of a square of sidelength 1 if x=(2-sqrt(2))/2=0.29289321881345
% (1-x)=0.70710678118655, n=0.41421356237309 where (1+n)*(1-x)=1, n/2=0.20710678118655
\newcommand*{\fuse}[2]{{#1\raise0em\hbox{\scalebox{0.70710678118655}{\begin{adjustbox}{margin=0.20710678118655em 0em 0.20710678118655em 0em}{#2}\end{adjustbox}}}}}
\renewcommand*{\emph}[1]{{\CJKfamily{em}#1}}

\renewcommand*{\notenumintext}[1]{\hskip-1em\raise0.45em\hbox{\rotatebox{90}{\miniscule #1}}}
\makepagenote
\notepageref
\renewcommand*{\notesname}{註釋}
\renewcommand*{\notedivision}{\chapter{\CJKfamily{rm}\notesname}}
\renewcommand*{\printpageinnotes}[1]{（\pageref{#1}葉）}

\begin{document}

	\input{other/insideCover.tex}
	\pagestyle{myPage}
	\chapterstyle{myChapter}
	\punctstyle{quanjiao}
	\setlength{\parindent}{1em}

	\tableofcontents
	

	\begin{landscape}

	\CJKfamily{zhvert}
	\part[（一）]{︵一︶}
	\chapter{第一章}
	\input{part1/1.tex}

	\chapter{第二章}
	\input{part1/2.tex}
	\part{︵二︶}
	\part{︵三︶}
	\end{landscape}	
	\printpagenotes
	\printbibliography
\end{document}
